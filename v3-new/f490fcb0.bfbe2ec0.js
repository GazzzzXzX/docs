(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{280:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return r})),a.d(t,"rightToc",(function(){return o})),a.d(t,"default",(function(){return s}));a(52),a(25),a(20),a(21),a(53),a(0);var n=a(288);function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}var r={id:"introducing-mikroorm-typescript-data-mapper-orm-with-identity-map",title:"Introducing MikroORM, TypeScript data-mapper ORM with Identity Map",author:"Martin Ad\xe1mek",authorTitle:"Maintainer of MikroORM",authorURL:"https://github.com/B4nan",authorImageURL:"https://avatars1.githubusercontent.com/u/615580?s=460&v=4",authorTwitter:"B4nan",tags:["typescript","javascript","node","oop"]},o=[{value:"Motivation",id:"motivation",children:[]},{value:"Installation",id:"installation",children:[]},{value:"Defining entities",id:"defining-entities",children:[]},{value:"Persisting entities with EntityManager",id:"persisting-entities-with-entitymanager",children:[]},{value:"Fetching entities",id:"fetching-entities",children:[]},{value:"Working with references",id:"working-with-references",children:[]},{value:"Identity Map and Unit of\xa0Work",id:"identity-map-and-unit-of-work",children:[]},{value:"Collections",id:"collections",children:[]},{value:"What\u2019s next?",id:"whats-next",children:[]}],p={rightToc:o},c="wrapper";function s(e){var t=e.components,a=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,["components"]);return Object(n.b)(c,i({},p,a,{components:t,mdxType:"MDXLayout"}),Object(n.b)("p",null,"This might be the ORM you\u2019ve been looking for\u2026"),Object(n.b)("h2",{id:"motivation"},"Motivation"),Object(n.b)("p",null,"During my early days at university, I remember how quickly I fell in love with object oriented programming and the concepts of ",Object(n.b)("a",i({parentName:"p"},{href:"http://hibernate.org/orm/what-is-an-orm/"}),"Object-relational mapping")," and ",Object(n.b)("a",i({parentName:"p"},{href:"https://stackoverflow.com/questions/1222392/can-someone-explain-domain-driven-design-ddd-in-plain-english-please/1222488#1222488"}),"Domain Driven Design"),". Back then, I was mainly a PHP programmer (",Object(n.b)("em",{parentName:"p"},"while we did a lot of Java/Hibernate at school"),"), so a natural choice for me was to start using ",Object(n.b)("a",i({parentName:"p"},{href:"https://www.doctrine-project.org/"}),"Doctrine"),"."),Object(n.b)("p",null,"A few years ago, when I switched from PHP to Node.js (",Object(n.b)("em",{parentName:"p"},"and later to TypeScript"),"), I was really confused. How come there is nothing similar to Hibernate or Doctrine in the JavaScript world? About a year ago, I finally came across ",Object(n.b)("a",i({parentName:"p"},{href:"https://typeorm.io/"}),"TypeORM"),", and when I read this line in the readme I thought I found what I was looking for:"),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},"TypeORM is highly influenced by other ORMs, such as ",Object(n.b)("a",i({parentName:"p"},{href:"http://hibernate.org/orm/"}),"Hibernate"),", ",Object(n.b)("a",i({parentName:"p"},{href:"http://www.doctrine-project.org/"}),"Doctrine")," and ",Object(n.b)("a",i({parentName:"p"},{href:"https://www.asp.net/entity-framework"}),"Entity Framework"),".")),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*gWvTBke0c8BFLGR8u_5zSg.jpeg",alt:null}))),Object(n.b)("p",null,"I started playing with it immediately, but I got disappointed very quickly. No Identity Map that would keep track of all loaded entities. No Unit of Work that would handle transaction isolation. No unified API for references with very strange support for ",Object(n.b)("a",i({parentName:"p"},{href:"https://typeorm.io/#/relations-faq/how-to-use-relation-id-without-joining-relation"}),"accessing just the identifier without populating the entity"),", MongoDB driver (",Object(n.b)("em",{parentName:"p"},"which I was aiming to use"),") was experimental and I had a lot problems setting it up. After a few days of struggle, I went away from it."),Object(n.b)("p",null,"By that time, I started to think about writing something myself. And that is how ",Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/mikro-orm/mikro-orm"}),Object(n.b)("strong",{parentName:"a"},"MikroORM"))," started!"),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*f8phoYPnVRkwuV1wynXz_A.png",alt:null}))),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/mikro-orm/mikro-orm"}),"MikroORM")," is TypeScript ORM for Node.js based on Data Mapper, Unit of Work and Identity Map patterns.")),Object(n.b)("p",null,"Currently it supports ",Object(n.b)("strong",{parentName:"p"},"MongoDB"),", ",Object(n.b)("strong",{parentName:"p"},"MySQL, PostgreSQL")," and ",Object(n.b)("strong",{parentName:"p"},"SQLite")," databases, but more can be supported via ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/custom-driver/"}),"custom drivers right now"),". It has first class TypeScript support, while staying back compatible with ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/usage-with-js/"}),"Vanilla JavaScript"),"."),Object(n.b)("h2",{id:"installation"},"Installation"),Object(n.b)("p",null,"First install the module via ",Object(n.b)("inlineCode",{parentName:"p"},"yarn")," or ",Object(n.b)("inlineCode",{parentName:"p"},"npm")," and do not forget to install the database driver as well. Next you will need to enable support for ",Object(n.b)("a",i({parentName:"p"},{href:"https://www.typescriptlang.org/docs/handbook/decorators.html"}),"decorators"),Object(n.b)("br",{parentName:"p"}),"\n","in ",Object(n.b)("inlineCode",{parentName:"p"},"tsconfig.json")," via ",Object(n.b)("inlineCode",{parentName:"p"},"experimentalDecorators")," flag. Then call ",Object(n.b)("inlineCode",{parentName:"p"},"MikroORM.init")," as part of bootstrapping your application."),Object(n.b)("p",null,"Last step is to provide forked ",Object(n.b)("inlineCode",{parentName:"p"},"EntityManager")," for each request, so it will have its own unique ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/identity-map/"}),"Identity Map"),". To do so, you can use ",Object(n.b)("inlineCode",{parentName:"p"},"EntityManager.fork()")," method. Another way, that is more ",Object(n.b)("a",i({parentName:"p"},{href:"https://medium.freecodecamp.org/a-quick-intro-to-dependency-injection-what-it-is-and-when-to-use-it-7578c84fa88f"}),"DI")," friendly, is to create new ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/identity-map/#request-context"}),"request context")," for each request, which will use some ",Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/nodejs/node/blob/master/doc/api/async_hooks.md"}),"dark magic")," in the background to always pick the right ",Object(n.b)("inlineCode",{parentName:"p"},"EntityManager")," for you."),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/e1a87c76bc6d267cf4f28055d59bb212"}),"https://gist.github.com/B4nan/e1a87c76bc6d267cf4f28055d59bb212")," %}"),Object(n.b)("h2",{id:"defining-entities"},"Defining entities"),Object(n.b)("p",null,"To ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/defining-entities/"}),"define an entity"),", simply create a class and decorate it. Here is an example of ",Object(n.b)("inlineCode",{parentName:"p"},"Book")," entity defined for MongoDB driver:"),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/19f7e6d227f175bda307d344ac70d04e"}),"https://gist.github.com/B4nan/19f7e6d227f175bda307d344ac70d04e")," %}"),Object(n.b)("p",null,"As you can see, it\u2019s pretty simple and straightforward. Entities are simple JavaScript objects (",Object(n.b)("em",{parentName:"p"},"so called POJO"),"), decorated with ",Object(n.b)("inlineCode",{parentName:"p"},"@Entity")," decorator (",Object(n.b)("em",{parentName:"p"},"for TypeScript"),"), or accompanied with ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/usage-with-js/"}),"schema definition object")," (",Object(n.b)("em",{parentName:"p"},"for vanilla JavaScript"),"). No real restrictions are made, you do not have to extend any base class, you are more than welcome to ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/entity-constructors/"}),"use entity constructors")," for specifying required parameters to always keep the entity in valid state. The only requirement is to define the primary key property."),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*NlsF497deWAYi5FSijW9NQ.jpeg",alt:null}))),Object(n.b)("p",null,"You might be curious about the last line with ",Object(n.b)("inlineCode",{parentName:"p"},"Book")," as an interface. This is called ",Object(n.b)("a",i({parentName:"p"},{href:"https://www.typescriptlang.org/docs/handbook/declaration-merging.html#merging-interfaces"}),"interface merging")," and it is there to let TypeScript know the entity will have some extra API methods (like ",Object(n.b)("inlineCode",{parentName:"p"},"init()")," or ",Object(n.b)("inlineCode",{parentName:"p"},"isInitialized()"),") available as it will be monkey-patched during discovery process. More about this can be found ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/defining-entities/"}),"in the docs"),"."),Object(n.b)("h2",{id:"persisting-entities-with-entitymanager"},"Persisting entities with EntityManager"),Object(n.b)("p",null,"To save entity state to database, you need to ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/entity-manager/"}),"persist it"),". Persist takes care or deciding whether to use ",Object(n.b)("inlineCode",{parentName:"p"},"insert")," or ",Object(n.b)("inlineCode",{parentName:"p"},"update")," and computes appropriate change-set. As a result, only changed fields will be updated in database."),Object(n.b)("p",null,Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/"}),"MikroORM")," comes with support for ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/cascading/"}),"cascading persist and remove operations"),". Cascade persist is enabled by default, which means that by persisting an entity, all referenced entities will be automatically persisted too."),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/9a78b0bf501db5c9386650359c3bba3c"}),"https://gist.github.com/B4nan/9a78b0bf501db5c9386650359c3bba3c")," %}"),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*x6Oqsg8I4y4Z3FiWtn1ORA.gif",alt:null}))),Object(n.b)("h2",{id:"fetching-entities"},"Fetching entities"),Object(n.b)("p",null,"To fetch entities from database you can use ",Object(n.b)("inlineCode",{parentName:"p"},"find()")," and ",Object(n.b)("inlineCode",{parentName:"p"},"findOne()")," methods of ",Object(n.b)("inlineCode",{parentName:"p"},"EntityManager"),":"),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/3a91aa966fd2e58c3cdf690a66446e27"}),"https://gist.github.com/B4nan/3a91aa966fd2e58c3cdf690a66446e27")," %}"),Object(n.b)("p",null,"More convenient way of fetching entities from database is by using ",Object(n.b)("inlineCode",{parentName:"p"},"EntityRepository"),", that carries the entity name so you do not have to pass it to every ",Object(n.b)("inlineCode",{parentName:"p"},"find")," and ",Object(n.b)("inlineCode",{parentName:"p"},"findOne")," calls:"),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/8f49351879f70d4413d58863ef62cbf0"}),"https://gist.github.com/B4nan/8f49351879f70d4413d58863ef62cbf0")," %}"),Object(n.b)("h2",{id:"working-with-references"},"Working with references"),Object(n.b)("p",null,"Entity associations are mapped to entity references. Reference is an entity that has at least the identifier (",Object(n.b)("em",{parentName:"p"},"primary key"),"). This reference is stored in the Identity Map so you will get the same object reference when fetching the same document from database."),Object(n.b)("p",null,"Thanks to this concept, MikroORM offers unified API for accessing entity references, regardless of whether the entity is initialized or not. Even if you do not populate an association, there will be its reference with primary key set. You can call ",Object(n.b)("inlineCode",{parentName:"p"},"await entity.init()")," to initialize the entity. This will trigger database call and populate itself, keeping the same reference to entity object in identity map."),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/9299a15612055c5cf6847b44ae07975f"}),"https://gist.github.com/B4nan/9299a15612055c5cf6847b44ae07975f")," %}"),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*PY1hb2ufRhbevdIFt9jR1g.jpeg",alt:null}))),Object(n.b)("h2",{id:"identity-map-and-unit-of-work"},"Identity Map and Unit of\xa0Work"),Object(n.b)("p",null,Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/"}),"MikroORM")," uses the Identity Map in background to track objects. This means that whenever you fetch entity via ",Object(n.b)("inlineCode",{parentName:"p"},"EntityManager"),", MikroORM will keep a reference to it inside its ",Object(n.b)("inlineCode",{parentName:"p"},"UnitOfWork"),", and will always return the same instance of it, even if you query one entity via different properties. This also means you can compare entities via strict equality operators (",Object(n.b)("inlineCode",{parentName:"p"},"===")," and\xa0",Object(n.b)("inlineCode",{parentName:"p"},"!=="),"):"),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/6dda9783f442da93ef86e9f9c8b2d9bc"}),"https://gist.github.com/B4nan/6dda9783f442da93ef86e9f9c8b2d9bc")," %}"),Object(n.b)("p",null,"Another benefit of Identity Map is that this allows us to skip some database calls. When you try to load an already managed entity by its identifier, the one from Identity Map will be returned, without querying the database."),Object(n.b)("p",null,"The power of Unit of Work is in running all queries inside a batch and wrapped inside a transaction (",Object(n.b)("em",{parentName:"p"},"if supported by given driver"),"). This approach is usually more performant as opposed to firing queries from various places."),Object(n.b)("h2",{id:"collections"},"Collections"),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"OneToMany")," and ",Object(n.b)("inlineCode",{parentName:"p"},"ManyToMany")," collections are stored in a ",Object(n.b)("inlineCode",{parentName:"p"},"Collection")," wrapper. It implements iterator so you can use ",Object(n.b)("inlineCode",{parentName:"p"},"for of")," loop to iterate through it."),Object(n.b)("p",null,"Another way to access collection items is to use bracket syntax like when you access array items. Keep in mind that this approach will not check if the collection is initialized, while using ",Object(n.b)("inlineCode",{parentName:"p"},"get")," method will throw error in this case."),Object(n.b)("p",null,"{% gist ",Object(n.b)("a",i({parentName:"p"},{href:"https://gist.github.com/B4nan/d572179c3fa2edcc6e0bdee60f57d5c7"}),"https://gist.github.com/B4nan/d572179c3fa2edcc6e0bdee60f57d5c7")," %}"),Object(n.b)("p",null,"More informations about collections can be found ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/collections/"}),"in the docs"),"."),Object(n.b)("h2",{id:"whats-next"},"What\u2019s next?"),Object(n.b)("p",null,"So you read through the whole article, got here and still not satisfied? There are more articles to come (beginning with integration manual for popular frameworks like ",Object(n.b)("a",i({parentName:"p"},{href:"https://expressjs.com/"}),"Express")," or ",Object(n.b)("a",i({parentName:"p"},{href:"https://nestjs.com/"}),"NestJS"),"), but you can take a look at some advanced features covered in docs right now:"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/nested-populate/"}),"Smart nested populate")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/query-conditions/"}),"Smart query conditions")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/entity-helper/"}),"Updating entity values with ",Object(n.b)("inlineCode",{parentName:"a"},"IEntity.assign()"))," "),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/property-validation/"}),"Property validation")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/lifecycle-hooks/"}),"Lifecycle hooks")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/naming-strategy/"}),"Naming strategy")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/usage-with-nestjs/"}),"Usage with NestJS")),Object(n.b)("li",{parentName:"ul"},Object(n.b)("a",i({parentName:"li"},{href:"https://b4nan.github.io/mikro-orm/usage-with-js/"}),"Usage with JavaScript"))),Object(n.b)("p",null,Object(n.b)("img",i({parentName:"p"},{src:"https://cdn-images-1.medium.com/max/800/1*4877k4Hq9dPdtmvg9hnGFA.jpeg",alt:null}))),Object(n.b)("p",null,"To start playing with ",Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/mikro-orm/mikro-orm"}),"MikroORM"),", go through ",Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/mikro-orm/mikro-orm#quick-start"}),"quick start")," and ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/"}),"read the docs"),". You can also take a look at ",Object(n.b)("a",i({parentName:"p"},{href:"http://github.com/mikro-orm/mikro-orm-examples"}),"example integrations with some popular frameworks"),"."),Object(n.b)("blockquote",null,Object(n.b)("p",{parentName:"blockquote"},Object(n.b)("em",{parentName:"p"},"Like")," ",Object(n.b)("a",i({parentName:"p"},{href:"https://b4nan.github.io/mikro-orm/"}),Object(n.b)("em",{parentName:"a"},"MikroORM")),Object(n.b)("em",{parentName:"p"},"? \u2b50\ufe0f")," ",Object(n.b)("a",i({parentName:"p"},{href:"https://github.com/mikro-orm/mikro-orm"}),Object(n.b)("em",{parentName:"a"},"Star it"))," ",Object(n.b)("em",{parentName:"p"},"on GitHub and share this article with your friends."))),Object(n.b)("p",null,Object(n.b)("em",{parentName:"p"},"This article was originally published on Medium: ",Object(n.b)("a",i({parentName:"em"},{href:"https://medium.com/dailyjs/introducing-mikro-orm-typescript-data-mapper-orm-with-identity-map-9ba58d049e02"}),"https://medium.com/dailyjs/introducing-mikro-orm-typescript-data-mapper-orm-with-identity-map-9ba58d049e02"))))}s.isMDXComponent=!0},288:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return l}));var n=a(0),i=a.n(n),r=i.a.createContext({}),o=function(e){var t=i.a.useContext(r),a=t;return e&&(a="function"==typeof e?e(t):Object.assign({},t,e)),a},p=function(e){var t=o(e.components);return i.a.createElement(r.Provider,{value:t},e.children)};var c="mdxType",s={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},b=Object(n.forwardRef)((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,p=e.parentName,c=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&-1===t.indexOf(n)&&(a[n]=e[n]);return a}(e,["components","mdxType","originalType","parentName"]),b=o(a),l=n,m=b[p+"."+l]||b[l]||s[l]||r;return a?i.a.createElement(m,Object.assign({},{ref:t},c,{components:a})):i.a.createElement(m,Object.assign({},{ref:t},c))}));function l(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,o=new Array(r);o[0]=b;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p[c]="string"==typeof e?e:n,o[1]=p;for(var l=2;l<r;l++)o[l]=a[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);